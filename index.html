<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDD Platform - Integrity Due Diligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-6xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">IDD Platform</h1>
            <p class="text-gray-600">Integrity Due Diligence - Automated Background Checks</p>
        </div>

        <!-- Configuration -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Configuration</h2>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Backend URL (Vercel ou Cloudflare)
                </label>
                <input 
                    type="text" 
                    id="workerUrl" 
                    placeholder="https://idd-backend.vercel.app/api/search"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                <p class="text-xs text-gray-500 mt-1">
                    Vercel : https://ton-url.vercel.app/api/search<br>
                    Cloudflare : https://ton-url.workers.dev
                </p>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Perplexity API Key
                </label>
                <input 
                    type="password" 
                    id="apiKey" 
                    placeholder="pplx-..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                <p class="text-xs text-gray-500 mt-1">Votre cl√© API Perplexity (obtenue sur perplexity.ai/settings/api)</p>
            </div>
        </div>

        <!-- Search Form -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Lancer une recherche</h2>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Nom de la personne ou entit√©
                </label>
                <input 
                    type="text" 
                    id="entityName" 
                    placeholder="Ex: AMADOU KANE"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Pays (optionnel)
                </label>
                <input 
                    type="text" 
                    id="country" 
                    placeholder="Ex: SENEGAL"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
            </div>

            <button 
                onclick="performSearch()" 
                class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200"
            >
                üîç Lancer la recherche IDD
            </button>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden bg-white rounded-lg shadow-lg p-8 mb-6">
            <div class="flex flex-col items-center justify-center">
                <div class="loader mb-4"></div>
                <p class="text-gray-600">Recherche en cours...</p>
                <p class="text-sm text-gray-500 mt-2">Analyse de <span id="loadingQuery"></span></p>
            </div>
        </div>

        <!-- Results -->
        <div id="results" class="hidden">
            <!-- Risk Score -->
            <div id="riskScore" class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Risk Assessment</h2>
                <div class="flex items-center gap-4">
                    <div id="riskBadge" class="px-4 py-2 rounded-lg font-bold text-lg"></div>
                    <div class="text-sm text-gray-600">
                        <p id="riskDetails"></p>
                    </div>
                </div>
            </div>

            <!-- Findings -->
            <div id="findings" class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Investigation Results</h2>
                <div id="findingsList"></div>
            </div>
        </div>
    </div>

    <script>
        // Save config to localStorage
        function saveConfig() {
            localStorage.setItem('idd_worker_url', document.getElementById('workerUrl').value);
            localStorage.setItem('idd_api_key', document.getElementById('apiKey').value);
        }

        // Load config from localStorage
        function loadConfig() {
            document.getElementById('workerUrl').value = localStorage.getItem('idd_worker_url') || '';
            document.getElementById('apiKey').value = localStorage.getItem('idd_api_key') || '';
        }

        // Auto-save on change
        document.getElementById('workerUrl').addEventListener('change', saveConfig);
        document.getElementById('apiKey').addEventListener('change', saveConfig);

        // Load config on page load
        loadConfig();

        async function performSearch() {
            const entityName = document.getElementById('entityName').value.trim();
            const country = document.getElementById('country').value.trim();
            const workerUrl = document.getElementById('workerUrl').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();

            // Validation
            if (!entityName) {
                alert('‚ö†Ô∏è Veuillez entrer un nom');
                return;
            }

            if (!workerUrl) {
                alert('‚ö†Ô∏è Veuillez configurer votre URL Cloudflare Worker');
                return;
            }

            if (!apiKey) {
                alert('‚ö†Ô∏è Veuillez entrer votre cl√© API Perplexity');
                return;
            }

            // Build queries
            const queries = buildQueries(entityName, country);

            // Show loading
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
            document.getElementById('loadingQuery').textContent = entityName;

            try {
                // Call Cloudflare Worker
                const response = await fetch(workerUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        queries,
                        apiKey
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Request failed');
                }

                const data = await response.json();
                displayResults(entityName, data.results);

            } catch (error) {
                console.error('Search error:', error);
                alert(`‚ùå Erreur: ${error.message}\n\nV√©rifiez:\n- L'URL du Worker est correcte\n- Votre cl√© API Perplexity est valide\n- Le Worker est bien d√©ploy√©`);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function buildQueries(name, country) {
            const countryFilter = country ? ` ${country}` : '';
            
            return [
                `"${name}"${countryFilter} corruption OR fraud OR embezzlement OR financial misconduct OR money laundering`,
                `"${name}"${countryFilter} legal proceedings OR investigation OR court OR conviction OR prosecution OR lawsuit`,
                `"${name}"${countryFilter} sanctions OR OFAC OR blacklist OR embargo OR sanctions list`,
                `"${name}"${countryFilter} controversial OR scandal OR allegation OR accused`,
                `"${name}"${countryFilter} business OR company OR political position OR government role`
            ];
        }

        function displayResults(entityName, results) {
            // Calculate risk score
            const riskScore = calculateRisk(results);
            
            // Display risk badge
            const riskBadge = document.getElementById('riskBadge');
            const riskDetails = document.getElementById('riskDetails');
            
            if (riskScore >= 70) {
                riskBadge.className = 'px-4 py-2 rounded-lg font-bold text-lg bg-red-100 text-red-800';
                riskBadge.textContent = `HIGH RISK (${riskScore})`;
                riskDetails.textContent = 'Significant adverse findings detected';
            } else if (riskScore >= 40) {
                riskBadge.className = 'px-4 py-2 rounded-lg font-bold text-lg bg-yellow-100 text-yellow-800';
                riskBadge.textContent = `MEDIUM RISK (${riskScore})`;
                riskDetails.textContent = 'Some concerns identified, further review recommended';
            } else {
                riskBadge.className = 'px-4 py-2 rounded-lg font-bold text-lg bg-green-100 text-green-800';
                riskBadge.textContent = `LOW RISK (${riskScore})`;
                riskDetails.textContent = 'Limited or no adverse findings';
            }

            // Display findings
            const findingsList = document.getElementById('findingsList');
            findingsList.innerHTML = '';

            results.forEach((result, index) => {
                if (result.content) {
                    const finding = document.createElement('div');
                    finding.className = 'mb-6 p-4 bg-gray-50 rounded-lg';
                    
                    finding.innerHTML = `
                        <h3 class="font-semibold text-gray-800 mb-2">Finding #${index + 1}</h3>
                        <p class="text-sm text-gray-600 mb-2 italic">${result.query}</p>
                        <div class="text-gray-700 mb-3">${formatContent(result.content)}</div>
                        ${result.citations && result.citations.length > 0 ? `
                            <div class="mt-3">
                                <p class="text-xs font-semibold text-gray-600 mb-2">Sources:</p>
                                ${result.citations.map(citation => `
                                    <a href="${citation}" target="_blank" class="text-xs text-blue-600 hover:underline block mb-1">
                                        üìÑ ${citation}
                                    </a>
                                `).join('')}
                            </div>
                        ` : ''}
                    `;
                    
                    findingsList.appendChild(finding);
                }
            });

            document.getElementById('results').classList.remove('hidden');
        }

        function formatContent(content) {
            // Convert line breaks to <br>
            return content.replace(/\n/g, '<br>');
        }

        function calculateRisk(results) {
            let score = 0;
            
            results.forEach(result => {
                if (!result.content) return;
                
                const content = result.content.toLowerCase();
                
                // High risk keywords
                const highRiskKeywords = ['corruption', 'fraud', 'embezzlement', 'convicted', 'criminal', 'sanctions', 'laundering'];
                const mediumRiskKeywords = ['investigation', 'lawsuit', 'allegation', 'controversial', 'accused'];
                
                highRiskKeywords.forEach(keyword => {
                    if (content.includes(keyword)) score += 15;
                });
                
                mediumRiskKeywords.forEach(keyword => {
                    if (content.includes(keyword)) score += 8;
                });
            });

            return Math.min(score, 100);
        }
    </script>
</body>
</html>
